syntax = "proto3";

import "newsdoc/newsdoc.proto";

package elephant.user;

option go_package = "github.com/ttab/elephant-api/user";

// Settings service manages configuration for authenticated users.
//
// All methods in this service rely on the `sub` claim from the
// authentication (bearer) token to identify the target user.
service Settings {
  // Gets a specific document for the authenticated user.
  rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);
  // Lists documents for the authenticated user.
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);
  // Updates an existing or creates a new document for the authenticated user.
  rpc UpdateDocument(UpdateDocumentRequest) returns (UpdateDocumentResponse);
  // Deletes a document for the authenticated user.
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);
  // Polls for new and updated documents for the authenticated user.
  rpc PollDocuments(PollDocumentsRequest) returns (PollDocumentsResponse);

  // Gets a single property value for the authenticated user.
  rpc GetProperty(GetPropertyRequest) returns (GetPropertyResponse);
  // Lists properties for the authenticated user.
  rpc ListProperties(ListPropertiesRequest) returns (ListPropertiesResponse);
  // Sets or updates a single property for the authenticated user.
  rpc SetProperty(SetPropertyRequest) returns (SetPropertyResponse);
  // Deletes a property for the authenticated user.
  rpc DeleteProperty(DeletePropertyRequest) returns (DeletePropertyResponse);
  // Bulk sets properties for the authenticated user (e.g. for syncing or resetting state).
  rpc BulkSetProperties(BulkSetPropertiesRequest) returns (BulkSetPropertiesResponse);
    // Polls for new and updated properties for the authenticated user.
  rpc PollProperties(PollPropertiesRequest) returns (PollPropertiesResponse);
}

message GetDocumentRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Type is the content type of the document.
  string type = 2;
  // Unique identifier for the document within the scope of the application and type.
  // Can be a human readable slug or a UUID.
  string key = 3;
}

message GetDocumentResponse {
  Document document = 1;
}

message Document {
  // ID of the document's owner.
  // Matches the `sub` claim from the authentication token.
  string user = 1;
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 2;
  // Type is the content type of the document.
  string type = 3;
  // Unique identifier for the document within the scope of the application and type.
  // Can be a human readable slug or a UUID.
  string key = 4;
  // Version of the document.
  int64 version = 5;
  // Semver string indicating the schema version of the payload.
  string schema_version = 6;
  // Creation time in RFC3339 format.
  string created = 7;
  // Last update time in RFC3339 format.
  string updated = 8;
  // Payload contains a newsdoc document with actual configuration data.
  newsdoc.Document payload = 9;
}

message ListDocumentsRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Type is the content type of the document.
  string type = 2;
}

message ListDocumentsResponse {
  repeated Document documents = 1;
}

message UpdateDocumentRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Type is the content type of the document.
  string type = 2;
  // Unique identifier for the document within the scope of the application and type.
  // Can be a human readable slug or a UUID.
  string key = 3;
  // Semver string indicating the schema version of the payload.
  string schema_version = 4;
  // Payload contains a newsdoc document with actual configuration data.
  newsdoc.Document payload = 5;
}

message UpdateDocumentResponse {}

message DeleteDocumentRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Type is the content type of the document.
  string type = 2;
  // Unique identifier for the document within the scope of the application and type.
  // Can be a human readable slug or a UUID.
  string key = 3;
}

message DeleteDocumentResponse {}

message PollDocumentsRequest {
  // Time in RFC3339 format after which to start returning documents.
  // Leave unset for the initial request.
  string after_time = 1;
}

message PollDocumentsResponse {
  // Time in RFC3339 format of the most recent document returned. Use for subsequent polling requests.
  // If no documents are returned, it matches the `after_time` from the request.
  string last_time = 1;
  // Documents sorted in ascending order by last updated time (oldest first).
  repeated Document documents = 2;
}

// Property represents a generic key-value pair attached to a user.
// It can be used for preferences, user state, feature flags etc.
message Property {
  // User ID of the property owner.
  // Matches the `sub` claim from the authentication token.
  string user = 1;
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 2;
  // Unique identifier for the property within the application.
  string key = 3;
  // The value serialized as a string.
  string value = 4;
  // Creation time in RFC3339 format.
  string created = 5;
  // Last update time in RFC3339 format.
  string updated = 6;
}

message GetPropertyRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Unique identifier for the property within the application.
  string key = 2;
}

message GetPropertyResponse {
  Property property = 1;
}

message ListPropertiesRequest {
  // Filter by application ID.
  // If empty, returns all properties for the user across all applications.
  string application = 1;
}

message ListPropertiesResponse {
  repeated Property properties = 1;
}

message SetPropertyRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Unique identifier for the property within the application.
  string key = 2;
  // The value serialized as a string.
  string value = 3;
}

message SetPropertyResponse {}

message DeletePropertyRequest {
  // The unique application identifier in reverse domain notation
  // (e.g., `com.example.assignments` or `com.example.writer`).
  string application = 1;
  // Unique identifier for the property within the application.
  string key = 2;
}

message DeletePropertyResponse {}

message BulkSetPropertiesRequest {
  // The application ID for all properties in this batch.
  string application = 1;
  // A map of key-value pairs to set.
  map<string, string> properties = 2;
}

message BulkSetPropertiesResponse {}

message PollPropertiesRequest {
  // Time in RFC3339 format after which to start returning properties.
  // Leave unset for the initial request.
  string after_time = 1;
}

message PollPropertiesResponse {
  // Time in RFC3339 format of the most recent property returned. Use for subsequent polling requests.
  // If no properties are returned, it matches the `after_time` from the request.
  string last_time = 1;
  // Properties sorted in ascending order by last updated time (oldest first).
  repeated Property properties = 2;
}

service Messages {
  // Pushes a new message to a recipient.
  rpc PushMessage(PushMessageRequest) returns (PushMessageResponse);
  // Pushes a new inbox message to a recipient.
  rpc PushInboxMessage(PushInboxMessageRequest) returns (PushInboxMessageResponse);
  // Polls for new messages for a recipient.
  rpc PollMessages (PollMessagesRequest) returns (PollMessagesResponse);
  // Polls for new inbox messages for a recipient.
  rpc PollInboxMessages (PollInboxMessagesRequest) returns (PollInboxMessagesResponse);
  // Lists all inbox messages for a recipient.
  rpc ListInboxMessages (ListInboxMessagesRequest) returns (ListInboxMessagesResponse);
  // Updates an existing inbox message.
  rpc UpdateInboxMessage (UpdateInboxMessageRequest) returns (UpdateInboxMessageResponse);
  // Deletes an inbox message.
  rpc DeleteInboxMessage (DeleteInboxMessageRequest) returns (DeleteInboxMessageResponse);
}

message PushMessageRequest {
  // Type of message being sent (e.g. "rpc_error").
  string type = 1;
  // Recipient of the message (user sub).
  string recipient = 2;
  // UUID of the associated document, optional.
  string doc_uuid = 3;
  // Type of the associated document, optional.
  string doc_type = 4;
  // Payload containing a key-value map.
  map<string, string> payload = 5;
}

message PushMessageResponse {}

message PushInboxMessageRequest {
  // Recipient of the message (user sub).
  string recipient = 1;
  // Payload containing a newsdoc document.
  newsdoc.Document payload = 2;
}

message PushInboxMessageResponse {}

message PollMessagesRequest {
  // ID of the message after which to start returning messages.
  // Set to -1 for the initial request.
  int64 after_id = 1;
}

message PollMessagesResponse {
  // ID of the most recent message returned. Use for subsequent polling requests.
  // If no new messages are returned, it matches the `after_id` from the request.
  int64 last_id = 1;
  // Messages sorted in ascending order by id (oldest first).
  repeated Message messages = 2;
}

message Message {
  // ID of the message.
  int64 id = 1;
  // Type of message being sent (e.g. "rpc_error").
  string type = 2;
  // Created timestamp is the RFC3339 timestamp
  // for when the message was created.
  string created = 3;
  // Creator of the message (application sub).
  string created_by = 4;
  // Recipient of the message (user sub).
  string recipient = 5;
  // UUID of the associated document, optional.
  string doc_uuid = 6;
  // Type of the associated document, optional.
  string doc_type = 7;
  // Payload containing a key-value map.
  map<string, string> payload = 8;
}

message PollInboxMessagesRequest {
  // ID of the message after which to start returning messages.
  // Set to -1 for the initial request.
  int64 after_id = 1;
}

message PollInboxMessagesResponse {
  // ID of the most recent message returned. Use for subsequent polling requests.
  // If no new messages are returned, it matches the `after_id` from the request.
  int64 last_id = 1;
  // Messages sorted in ascending order by id (oldest first).
  repeated InboxMessage messages = 2;
}

message InboxMessage {
  // Recipient of the message (user sub).
  string recipient = 1;
  // ID of the message.
  int64 id = 2;
  // Created timestamp is the RFC3339 timestamp
  // for when the message was created.
  string created = 3;
  // Creator of the message (application sub).
  string created_by = 4;
  // Updated timestamp is the RFC3339 timestamp
  // for when the message was last updated.
  string updated = 5;
  // Indicates whether the message has been read.
  bool is_read = 6;
  // Payload containing a newsdoc document.
  newsdoc.Document payload = 7;
}

message ListInboxMessagesRequest {
  // ID of the message before which to list messages.
  int64 before_id = 1;
  // Number of messages to include in the results (defaults to 10).
  int64 size = 2;
}

message ListInboxMessagesResponse {
  // ID of the latest message returned. Useful for subsequent polling requests.
  int64 latest_id = 1;
  // ID of the earliest message returned. Use for paginating backward.
  int64 earliest_id = 2;
  // Messages sorted in descending order by id (newest first).
  repeated InboxMessage messages = 3;
}

message UpdateInboxMessageRequest {
  // ID of the message.
  int64 id = 1;
  // Sets the message's read status.
  bool is_read = 2;
}

message UpdateInboxMessageResponse {}

message DeleteInboxMessageRequest {
  // ID of the message.
  int64 id = 1;
}

message DeleteInboxMessageResponse {}
