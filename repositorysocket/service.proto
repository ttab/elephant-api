syntax = "proto3";

import "newsdoc/newsdoc.proto";
import "repository/service.proto";

package elephant.repositorysocket;

option go_package = "github.com/ttab/elephant-api/repositorysocket";

// CallGetDocuments is used to fetch and optionally subscribe to a set of
// documents.
message CallGetDocuments {
  // SetName is the name of the document set. Required when subscribing.
  string set_name  = 1;
  // Subscribe should be set to true to get notified when the document set
  // changes.
  bool subscribe   = 2;
  // Type of the documents to get.
  string type      = 3;
  // FromTime is the inclusive start time range to get documents for.
  string from_time = 4;
  // FromTime is the exclusive end of the time range to get documents
  // for.
  string to_time   = 5;
  // Filter to apply to the documents.
  DocumentFilter filter = 6;
}

// CallCloseDocumentSet is used to stop recieving updates for a document set.
message CallCloseDocumentSet {
  // SetName is the name of the document set to close.
  string set_name = 1;
}

// RespGetDocumentsBatch is emitted in response to a CallGetDocuments
// message. Multiple batch messages can be emitted for a single get documents
// call.
message RespGetDocumentsBatch {
  // SetName is the name of the set that result is for.
  string set_name                  = 1;
  // Documents is a batch of documents that are included in the set.
  repeated DocumentState documents = 2;
  // FinalBatch is set to true for the last batch in the response.
  bool final_batch                 = 3;
}

message DocumentState {
  // Meta information about the document.
  repository.DocumentMeta meta = 1;
  // Document is the document itself.
  newsdoc.Document document    = 2;
}

// RespDocumentUpdate is emitted when a write operation has affected a document
// in a set.
message RespDocumentUpdate {
  // SetName is the name of the set that result is for.
  string set_name               = 1;
  // Event is the change event for the document.
  repository.EventlogItem event = 2;
  // Document is included for document update events.
  newsdoc.Document document     = 3;
}

enum FilterOperator {
  FILTER_OP_UNKNOWN = 0;
  FILTER_OP_ANY     = 1;
  FILTER_OP_ALL     = 2;
  FILTER_OP_NONE    = 3;
}

message DocumentFilter {
  // Expression used to extract values from the document.
  string expression            = 1;
  // Operator to use when comparing the provided values to the extracted values.
  FilterOperator operator      = 2;
  // Values to compare to the extracted values.
  repeated FilterValues values = 3;
  // And filters that all must be true.
  repeated DocumentFilter and  = 4;
  // Or filters of which at least one must be true.
  repeated DocumentFilter or   = 5;
}

message FilterValues {
  map<string, string> values = 1;
}
